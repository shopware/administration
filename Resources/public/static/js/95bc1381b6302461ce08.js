(window.webpackJsonpAdministration=window.webpackJsonpAdministration||[]).push([[54955],{799546:function(){},354955:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return i}}),a(163433);let{Criteria:n}=Shopware.Data;var i={template:'\n{% block sw_order_detail_state_card %}\n<sw-card\n    class="sw-order-detail-state-card"\n    position-identifier="sw-order-details-state"\n    :title="title"\n    :is-loading="isLoading"\n>\n\n    \n    {% block sw_order_detail_state_card_state %}\n    <div class="sw-order-detail-state-card__state">\n        <sw-container\n            class="sw-order-detail-state-card__state-container"\n            gap="16px"\n            columns="33% auto auto"\n        >\n\n            \n            {% block sw_order_detail_state_card_state_select %}\n            <sw-order-state-select-v2\n                v-tooltip="{\n                    message: $tc(\'sw-privileges.tooltip.warning\'),\n                    disabled: acl.can(\'order.editor\'),\n                    showOnDisabledElements: true\n                }"\n                :transition-options="stateOptions"\n                :state-type="entityName"\n                rounded-style\n                :placeholder="entity.stateMachineState.translated.name"\n                :label="stateLabel"\n                :background-style="stateSelectBackgroundStyle"\n                :disabled="disabled"\n                :is-loading="statesLoading"\n                @state-select="onStateSelected"\n            />\n            {% endblock %}\n\n            \n            {% block sw_order_detail_state_card_state_history_text %}\n            <div\n                v-if="lastStateChange"\n                class="sw-order-detail-state-card__state-history-text"\n            >\n                <i18n path="sw-order.stateCard.labelHistory">\n                    <template #time>\n                        <sw-time-ago :date="lastStateChange.createdAt" />\n                    </template>\n                    <template #author>\n                        {{ lastStateChange.user ? lastStateChange.user.firstName + \' \' + lastStateChange.user.lastName : $tc(\'sw-order.stateCard.labelSystemUser\') }}\n                    </template>\n                </i18n>\n            </div>\n            <div v-else></div>\n            {% endblock %}\n\n            \n            {% block sw_order_detail_state_card_state_history_button %}\n            <sw-external-link\n                class="sw-order-detail-state-card__state-history-button"\n                icon="regular-long-arrow-right"\n                @click="onShowStatusHistory"\n            >\n                {{ $tc(\'sw-order.stateCard.labelShowHistoryModal\') }}\n            </sw-external-link>\n            {% endblock %}\n\n        </sw-container>\n\n        \n        {% block sw_order_state_change_card_state_modal %}\n        <sw-order-state-change-modal\n            v-if="showStateChangeModal"\n            :order="order"\n            :is-loading="isLoading"\n            :technical-name="\'\'"\n            @page-leave="onLeaveModalClose"\n            @page-leave-confirm="onLeaveModalConfirm"\n        />\n        {% endblock %}\n    </div>\n    {% endblock %}\n\n    \n    {% block sw_order_state_change_card_divider %}\n    <hr class="sw-order-detail-state-card__divider">\n    {% endblock %}\n\n    \n    {% block sw_order_state_change_card_content %}\n    <sw-container\n        class="sw-order-detail-state-card__content"\n        columns="1fr 1fr"\n    >\n        <slot></slot>\n    </sw-container>\n    {% endblock %}\n\n</sw-card>\n{% endblock %}\n',inject:["acl","repositoryFactory","orderStateMachineService","stateMachineService","stateStyleDataProviderService"],mixins:["notification"],props:{order:{type:Object,required:!0},title:{type:String,required:!1,default:""},entity:{type:Object,required:!0},stateLabel:{type:String,required:!1,default:""},isLoading:{type:Boolean,required:!1,default:!1},disabled:{type:Boolean,required:!1,default:!1}},data(){return{statesLoading:!1,stateOptions:[],lastStateChange:null,currentActionName:null,showStateChangeModal:!1,stateChangeModalConfirmed:!1}},computed:{stateMachineStateRepository(){return this.repositoryFactory.create("state_machine_state")},stateMachineHistoryRepository(){return this.repositoryFactory.create("state_machine_history")},stateMachineStateCriteria(){let t=new n(1,null);return t.addSorting({field:"name",order:"ASC"}),t.addAssociation("stateMachine"),t.addFilter(n.equals("state_machine_state.stateMachine.technicalName",`${this.entityName}.state`)),t},stateMachineHistoryCriteria(){let t=new n(1,1);return t.addFilter(n.equals("referencedId",this.entity.id)),t.addFilter(n.equals("entityName",this.entityName)),t.addAssociation("user"),t.addSorting({field:"createdAt",order:"DESC"}),t},entityName(){return this.entity.getEntityName()},stateName(){return this.entity.stateMachineState.translated.name},stateSelectBackgroundStyle(){let t=this.entity.stateMachineState.technicalName;return this.stateStyleDataProviderService.getStyle(`${this.entityName}.state`,t).selectBackgroundStyle},stateTransitionMethod(){switch(this.entityName){case"order":return this.orderStateMachineService.transitionOrderState.bind(this.orderStateMachineService);case"order_transaction":return this.orderStateMachineService.transitionOrderTransactionState.bind(this.orderStateMachineService);case"order_delivery":return this.orderStateMachineService.transitionOrderDeliveryState.bind(this.orderStateMachineService);default:return null}}},created(){this.createdComponent()},methods:{createdComponent(){this.getTransitionOptions(),this.getLastChange()},onShowStatusHistory(){this.$emit("show-status-history")},getTransitionOptions(){return this.statesLoading=!0,Promise.all([this.stateMachineStateRepository.search(this.stateMachineStateCriteria),this.stateMachineService.getState(this.entityName,this.entity.id)]).then(t=>(this.stateOptions=this.buildTransitionOptions(t[0],t[1].data.transitions),this.statesLoading=!1,Promise.resolve()))},buildTransitionOptions(t,e){let a=t.map((t,e)=>({stateName:t.technicalName,id:e,name:t.translated.name,disabled:!0}));return a.forEach(t=>{let a=e.filter(e=>e.toStateName===t.stateName);a.length>=1&&(t.disabled=!1,t.id=a[0].actionName)}),a},onStateSelected(t,e){if(!t||!e){this.createStateChangeErrorNotification(this.$tc("sw-order.stateCard.labelErrorNoAction"));return}if(!this.modalConfirmed){this.currentActionName=e,this.showStateChangeModal=!0;return}this.stateChangeModalConfirmed=!1},onLeaveModalClose(){this.stateChangeModalConfirmed=!1,this.currentActionName=null,this.showStateChangeModal=!1},onLeaveModalConfirm(t,e=!0){this.showStateChangeModal=!1,this.stateTransitionMethod(this.entity.id,this.currentActionName,{documentIds:t,sendMail:e}).then(()=>(this.getLastChange(),this.getTransitionOptions())).then(()=>{this.$emit("save-edits")}).catch(t=>{this.createStateChangeErrorNotification(t)}).finally(()=>{this.stateChangeModalConfirmed=!1,this.currentActionName=null})},createStateChangeErrorNotification(t){this.createNotificationError({message:this.$tc("sw-order.stateCard.labelErrorStateChange")+t})},getLastChange(){this.lastStateChange=null,this.stateMachineHistoryRepository.search(this.stateMachineHistoryCriteria).then(t=>{this.lastStateChange=t.first()})}}}},163433:function(t,e,a){var n=a(799546);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[t.id,n,""]]),n.locals&&(t.exports=n.locals),a(745346).Z("1c667596",n,!0,{})}}]);