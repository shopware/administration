(window.webpackJsonpAdministration=window.webpackJsonpAdministration||[]).push([[58676],{172932:function(){},458676:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return a}}),o(48994);let{Component:r}=Shopware,{ChangesetGenerator:i}=Shopware.Data,{mapState:n}=r.getComponentHelper();var a={template:'\n{% block sw_order_promotion_field %}\n<div class="sw-order-promotion-field">\n\n    \n    {% block sw_order_promotion_field_codes %}\n    <sw-order-promotion-tag-field\n        v-model:value="promotionCodeTags"\n        :disabled="!hasLineItem || isLoading || !acl.can(\'order.editor\') || undefined"\n        :currency="currency"\n        :label="$tc(\'sw-order.detailsTab.promotionsField.labelPromotions\')"\n        :placeholder="$tc(\'sw-order.detailsTab.promotionsField.placeholderPromotions\')"\n        :error="promotionError"\n        @on-remove-code="onRemoveExistingCode"\n    />\n    {% endblock %}\n\n    \n    {% block sw_order_promotion_field_switch %}\n    <sw-switch-field\n        v-model:value="disabledAutoPromotions"\n        :disabled="isLoading || !acl.can(\'order.editor\') || undefined"\n        :label="$tc(\'sw-order.detailsTab.promotionsField.labelToggleAutomaticPromotions\')"\n    />\n    {% endblock %}\n\n</div>\n{% endblock %}\n',compatConfig:Shopware.compatConfig,inject:{swOrderDetailOnLoadingChange:{from:"swOrderDetailOnLoadingChange",default:null},swOrderDetailOnError:{from:"swOrderDetailOnError",default:null},swOrderDetailOnReloadEntityData:{from:"swOrderDetailOnReloadEntityData",default:null},repositoryFactory:{from:"repositoryFactory",default:null},orderService:{from:"orderService",default:null},acl:{from:"acl",default:null}},emits:["loading-change","error","reload-entity-data"],mixins:["notification"],props:{isLoading:{type:Boolean,required:!1,default:!1}},data(){return{promotionError:null,disabledAutoPromotions:!1}},computed:{...n("swOrderDetail",["order","versionContext"]),orderLineItemRepository(){return this.repositoryFactory.create("order_line_item")},hasLineItem(){return this.order.lineItems.filter(e=>e.hasOwnProperty("id")).length>0},currency(){return this.order.currency},manualPromotions(){return this.order.lineItems.filter(e=>"promotion"===e.type&&null!==e.referencedId)},automaticPromotions(){return this.order.lineItems.filter(e=>"promotion"===e.type&&null===e.referencedId)},promotionCodeTags:{get(){return this.manualPromotions.map(e=>e.payload)},set(e){let t=this.manualPromotions;if(this.promotionError=null,e.length<t.length)return;let o=t.length,r=e[o];e.length>t.length&&this.onSubmitCode(r.code),o>0&&r.isInvalid&&(this.promotionError={detail:this.$tc("sw-order.createBase.textInvalidPromotionCode")})}},hasAutomaticPromotions(){return this.automaticPromotions.length>0},changesetGenerator(){return new i},hasOrderUnsavedChanges(){return null!==this.changesetGenerator.generate(this.order).changes}},watch:{disabledAutoPromotions(e,t){t!==this.hasAutomaticPromotions&&this.toggleAutomaticPromotions(e)},automaticPromotions(){this.disabledAutoPromotions=!this.hasAutomaticPromotions}},created(){this.createdComponent()},methods:{createdComponent(){this.disabledAutoPromotions=!this.hasAutomaticPromotions},deleteAutomaticPromotions(){if(0===this.automaticPromotions.length)return Promise.resolve();let e=[];return this.automaticPromotions.forEach(t=>{e.push(this.orderLineItemRepository.delete(t.id,this.versionContext))}),Promise.all(e).then(()=>{this.automaticPromotions.forEach(e=>{this.createNotificationSuccess({message:this.$tc("sw-order.detailBase.textPromotionRemoved",0,{promotion:e.label})})})}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},toggleAutomaticPromotions(e){if(this.$emit("loading-change",!0),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse(),this.$nextTick(()=>{this.disabledAutoPromotions=!e});return}this.deleteAutomaticPromotions().then(()=>this.orderService.toggleAutomaticPromotions(this.order.id,this.order.versionId,e)).then(e=>{this.handlePromotionResponse(e),this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},onSubmitCode(e){if(this.$emit("loading-change",!0),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse();return}this.orderService.addPromotionToOrder(this.order.id,this.order.versionId,e).then(e=>{this.handlePromotionResponse(e),this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},handlePromotionResponse(e){Object.values(e.data.errors).forEach(e=>{switch(e.level){case 0:this.createNotificationSuccess({message:e.message});break;case 10:this.createNotificationWarning({message:e.message});break;default:this.createNotificationError({message:e.message})}})},handleUnsavedOrderChangesResponse(){this.createNotificationWarning({message:this.$tc("sw-order.detailBase.textUnsavedChanges",0)})},onRemoveExistingCode(e){if(this.$emit("loading-change",!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse();return}let t=this.order.lineItems.find(t=>"promotion"===t.type&&t.payload.code===e.code);this.orderLineItemRepository.delete(t.id,this.versionContext).then(()=>{this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},getLineItemByPromotionCode(e){return this.order.lineItems.find(t=>"promotion"===t.type&&t.payload.code===e)}}}},48994:function(e,t,o){var r=o(172932);r.__esModule&&(r=r.default),"string"==typeof r&&(r=[[e.id,r,""]]),r.locals&&(e.exports=r.locals),o(745346).Z("3e347f9a",r,!0,{})}}]);