(this.webpackJsonpAdministration=this.webpackJsonpAdministration||[]).push([[261],{AoIp:function(e,t,o){var i=o("zEvv");i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.i,i,""]]),i.locals&&(e.exports=i.locals);(0,o("ydqr").default)("0e33bbc2",i,!0,{})},prWp:function(e,t,o){"use strict";o.r(t);var i=o("J58c"),n=o.n(i),a=(o("AoIp"),o("mlQo"));function s(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?s(Object(o),!0).forEach((function(t){n()(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):s(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var l=Shopware,c=l.Component,u=l.Mixin,w=l.Context,f=l.State,d=l.Utils,m=l.Service,p=Shopware.Data,h=p.Criteria,g=p.EntityCollection,S=Shopware.Utils.object.cloneDeep,v=c.getComponentHelper(),y=v.mapState,F=v.mapGetters,_=v.mapPropertyErrors;t.default={template:'\n{% block sw_flow_detail %}\n<sw-page class="sw-flow-detail">\n    \n    {% block sw_flow_detail_header %}\n    <template #smart-bar-header>\n        <h2>{{ placeholder(flow, \'name\', $tc(\'sw-flow.detail.textHeadline\')) }}</h2>\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_flow_detail_smart_bar_actions %}\n    <template #smart-bar-actions>\n        \n        {% block sw_flow_detail_smart_bar_actions_save %}\n        <sw-button-process\n            v-tooltip="{\n                message: $tc(\'sw-privileges.tooltip.warning\'),\n                disabled: acl.can(\'flow.editor\'),\n                position: \'bottom\',\n                showOnDisabledElements: true\n            }"\n            class="sw-flow-detail__save"\n            variant="primary"\n            :is-loading="isLoading"\n            :process-success="isSaveSuccessful"\n            :disabled="!acl.can(\'flow.editor\')"\n            @process-finish="saveFinish"\n            @click.prevent="onSave"\n        >\n            {{ $tc(\'global.default.save\') }}\n        </sw-button-process>\n        {% endblock %}\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_flow_content %}\n    <template #content>\n        \n        {% block sw_flow_leave_page_modal %}\n        <sw-flow-leave-page-modal\n            v-if="showLeavePageWarningModal"\n            @page-leave-cancel="onLeaveModalClose"\n            @page-leave-confirm="onLeaveModalConfirm"\n        />\n        {% endblock %}\n\n        <sw-card-view :class="{\'sw-flow-detail__template\': isTemplate }">\n            \n            {% block sw_flow_tabs_header %}\n            <sw-tabs position-identifier="sw-flow-detail">\n                \n                {% block sw_flow_tabs_header_general %}\n                <sw-tabs-item\n                    class="sw-flow-detail__tab-general"\n                    :route="routeDetailTab(\'general\')"\n                >\n                    {{ $tc(\'sw-flow.page.tabGeneral\') }}\n                </sw-tabs-item>\n                {% endblock %}\n\n                \n                {% block sw_flow_tabs_header_builder %}\n                <sw-tabs-item\n                    class="sw-flow-detail__tab-flow"\n                    :route="routeDetailTab(\'flow\')"\n                >\n                    {{ $tc(\'sw-flow.page.tabFlow\') }}\n                </sw-tabs-item>\n                {% endblock %}\n\n                \n                {% block sw_flow_tabs_header_extension %}{% endblock %}\n            </sw-tabs>\n            {% endblock %}\n            <sw-alert\n                v-if="isTemplate"\n                variant="warning"\n                class="sw-flow-detail__warning"\n            >\n                {{ $tc(\'sw-flow.flowNotification.messageWarningSave\') }}\n            </sw-alert>\n            \n            {% block sw_flow_tabs_content %}\n            <template v-if="isLoading">\n                <sw-skeleton />\n                <sw-skeleton />\n            </template>\n\n            <router-view\n                v-else\n                :is-loading="isLoading"\n                :is-new-flow="isNewFlow"\n                :is-template="isTemplate"\n            />\n            {% endblock %}\n        </sw-card-view>\n\n        \n        {% block sw_flow_detail_modal_extension %}{% endblock %}\n    </template>\n    {% endblock %}\n</sw-page>\n{% endblock %}\n',inject:["acl","repositoryFactory","feature"],mixins:[u.getByName("placeholder"),u.getByName("notification")],props:{flowId:{type:String,required:!1,default:null}},data:function(){return{isLoading:!1,isSaveSuccessful:!1,showLeavePageWarningModal:!1,nextRoute:null}},metaInfo:function(){return{title:this.$createTitle(this.identifier)}},computed:r(r(r({identifier:function(){var e;return null===(e=this.flow)||void 0===e?void 0:e.name},flowRepository:function(){return this.repositoryFactory.create("flow")},flowTemplateRepository:function(){return this.repositoryFactory.create("flow_template")},flowSequenceRepository:function(){return this.repositoryFactory.create("flow_sequence")},isNewFlow:function(){return!this.flowId},flowCriteria:function(){var e=new h(1,25);return e.addAssociation("sequences.rule"),e.getAssociation("sequences").addSorting(h.sort("displayGroup","ASC")).addSorting(h.sort("parentId","ASC")).addSorting(h.sort("trueCase","ASC")).addSorting(h.sort("position","ASC")),e},flowTemplateCriteria:function(){return new h(1,25)},documentTypeRepository:function(){return this.repositoryFactory.create("document_type")},documentTypeCriteria:function(){var e=new h(1,100);return e.addSorting(h.sort("name","ASC")),e},mailTemplateRepository:function(){return this.repositoryFactory.create("mail_template")},customFieldSetRepository:function(){return this.repositoryFactory.create("custom_field_set")},customFieldRepository:function(){return this.repositoryFactory.create("custom_field")},mailTemplateIdsCriteria:function(){var e=new h(1,25);return e.addAssociation("mailTemplateType"),e.addFilter(h.equalsAny("id",this.mailTemplateIds)),e},customerGroupRepository:function(){return this.repositoryFactory.create("customer_group")},customerGroupCriteria:function(){var e=new h(1,100);return e.addSorting(h.sort("name","ASC")),e},stateMachineStateRepository:function(){return this.repositoryFactory.create("state_machine_state")},stateMachineStateCriteria:function(){var e=new h(1,null);return e.addSorting({field:"name",order:"ASC"}),e.addAssociation("stateMachine"),e.addFilter(h.equalsAny("state_machine_state.stateMachine.technicalName",["order.state","order_transaction.state","order_delivery.state"])),e},customFieldSetCriteria:function(){var e=new h(1,25);return e.addFilter(h.equalsAny("id",this.customFieldSetIds)),e},customFieldCriteria:function(){var e=new h(1,25);return e.addFilter(h.equalsAny("id",this.customFieldIds)),e},ruleRepository:function(){return this.repositoryFactory.create("rule")},isTemplate:function(){var e;return"template"===(null===(e=this.$route.query)||void 0===e?void 0:e.type)}},y("swFlowState",["flow"])),F("swFlowState",["sequences","mailTemplateIds","customFieldSetIds","customFieldIds","hasFlowChanged"])),_("flow",["name","eventName"])),watch:{flowId:function(){this.$route.params.flowTemplateId||this.getDetailFlow()}},created:function(){this.createdComponent()},beforeRouteLeave:function(e,t,o){this.flow._isNew?o():this.hasFlowChanged?(this.nextRoute=o,this.showLeavePageWarningModal=!0):o()},beforeDestroy:function(){this.beforeDestroyComponent()},methods:{createdComponent:function(){Shopware.ExtensionAPI.publishData({id:"sw-flow-detail__flow",path:"flow",scope:this}),this.isTemplate?this.getDetailFlowTemplate():this.flowId?this.getDetailFlow():this.createNewFlow()},beforeDestroyComponent:function(){f.dispatch("swFlowState/resetFlowState")},routeDetailTab:function(e){return e?this.isNewFlow?{name:"sw.flow.create.".concat(e)}:this.isTemplate?{name:"sw.flow.detail.".concat(e),query:{type:"template"}}:{name:"sw.flow.detail.".concat(e)}:{}},createNewFlow:function(){if(this.$route.params.flowTemplateId)return this.createFromFlowTemplate();var e=this.flowRepository.create();return e.id=d.createId(),e.priority=0,e.eventName="",f.commit("swFlowState/setFlow",e)},getDetailFlow:function(){var e=this;return this.isLoading=!0,this.flowRepository.get(this.flowId,w.api,this.flowCriteria).then((function(t){f.commit("swFlowState/setFlow",t),f.commit("swFlowState/setOriginFlow",S(t)),e.getDataForActionDescription()})).catch((function(){e.createNotificationError({message:e.$tc("sw-flow.flowNotification.messageError")})})).finally((function(){e.isLoading=!1}))},getDetailFlowTemplate:function(){var e=this;return this.isLoading=!0,this.flowTemplateRepository.get(this.flowId,w.api,this.flowTemplateCriteria).then((function(t){f.commit("swFlowState/setFlow",t),f.commit("swFlowState/setOriginFlow",S(t)),e.getDataForActionDescription(),e.getRuleDataForFlowTemplate()})).catch((function(){e.createNotificationError({message:e.$tc("sw-flow.flowNotification.messageError")})})).finally((function(){e.isLoading=!1}))},onSave:function(){var e=this;return this.removeAllSelectors(),this.validateEmptySequence().length?(this.createNotificationWarning({message:this.$tc("sw-flow.flowNotification.messageRequiredEmptyFields")}),null):(this.isSaveSuccessful=!1,this.isLoading=!0,this.isTemplate?(this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageWarningSave")}),this.isLoading=!1,null):this.flowRepository.save(this.flow).then((function(){"function"==typeof e.flow.isNew&&e.flow.isNew()||e.$route.params.flowTemplateId?(e.createNotificationSuccess({message:e.$tc("sw-flow.flowNotification.messageCreateSuccess")}),e.$router.push({name:"sw.flow.detail",params:{id:e.flow.id}})):e.getDetailFlow(),e.isSaveSuccessful=!0})).catch((function(){e.createNotificationError({message:e.$tc("sw-flow.flowNotification.messageSaveError")}),e.handleFieldValiationError()})).finally((function(){e.isLoading=!1})))},handleFieldValiationError:function(){if(this.flowNameError||this.flowEventNameError){var e=this.$router.history.current.name,t=("sw.flow.create.flow"===e||"sw.flow.detail.flow"===e)&&this.flowEventNameError,o=("sw.flow.create.general"===e||"sw.flow.detail.general"===e)&&this.flowNameError;t||o||(this.flowId?this.$router.push({name:this.flowNameError?"sw.flow.detail.general":"sw.flow.detail.flow",params:{flowId:this.flowId}}):this.$router.push({name:this.flowNameError?"sw.flow.create.general":"sw.flow.create.flow"}))}},saveFinish:function(){this.isLoading=!1,this.isSaveSuccessful=!1},onLeaveModalClose:function(){this.nextRoute(!1),this.nextRoute=null,this.showLeavePageWarningModal=!1},onLeaveModalConfirm:function(){var e=this;this.showLeavePageWarningModal=!1,this.$nextTick((function(){e.nextRoute()}))},removeAllSelectors:function(){var e=this.sequences.filter((function(e){return null!==e.ruleId||null!==e.actionName}));f.commit("swFlowState/setSequences",e)},validateEmptySequence:function(){var e=this.sequences.reduce((function(e,t){return""!==t.ruleId&&""!==t.actionName||e.push(t.id),e}),[]);return f.commit("swFlowState/setInvalidSequences",e),e},getDataForActionDescription:function(){if(!this.sequences)return null;var e=[];return this.sequences.some((function(e){return e.actionName===a.a.SET_ORDER_STATE}))&&e.push(this.stateMachineStateRepository.search(this.stateMachineStateCriteria).then((function(e){f.commit("swFlowState/setStateMachineState",e)}))),this.sequences.some((function(e){return e.actionName===a.a.GENERATE_DOCUMENT}))&&e.push(this.documentTypeRepository.search(this.documentTypeCriteria).then((function(e){Shopware.State.commit("swFlowState/setDocumentTypes",e)}))),this.sequences.some((function(e){return e.actionName===a.a.MAIL_SEND}))&&e.push(this.mailTemplateRepository.search(this.mailTemplateIdsCriteria).then((function(e){Shopware.State.commit("swFlowState/setMailTemplates",e)}))),this.sequences.some((function(e){return e.actionName===a.a.CHANGE_CUSTOMER_GROUP}))&&e.push(this.customerGroupRepository.search(this.customerGroupCriteria).then((function(e){Shopware.State.commit("swFlowState/setCustomerGroups",e)}))),this.sequences.some((function(e){return[a.a.SET_ORDER_CUSTOM_FIELD,a.a.SET_CUSTOMER_CUSTOM_FIELD,a.a.SET_CUSTOMER_GROUP_CUSTOM_FIELD].includes(e.actionName)}))&&(e.push(this.customFieldSetRepository.search(this.customFieldSetCriteria).then((function(e){Shopware.State.commit("swFlowState/setCustomFieldSets",e)}))),e.push(this.customFieldRepository.search(this.customFieldCriteria).then((function(e){Shopware.State.commit("swFlowState/setCustomFields",e)})))),Promise.all(e)},createFromFlowTemplate:function(){var e=this,t=this.flowRepository.create();return t.id=d.createId(),t.priority=0,this.flowTemplateRepository.get(this.$route.params.flowTemplateId,w.api,this.flowTemplateCriteria).then((function(o){var i,n,a,s;t.name=o.name,t.eventName=null===(i=o.config)||void 0===i?void 0:i.eventName,t.description=null===(n=o.config)||void 0===n?void 0:n.description,t.sequences=e.buildSequencesFromConfig(null!==(a=null===(s=o.config)||void 0===s?void 0:s.sequences)&&void 0!==a?a:[]),f.commit("swFlowState/setFlow",t),f.commit("swFlowState/setOriginFlow",S(t)),e.getDataForActionDescription(),e.getRuleDataForFlowTemplate()})).catch((function(){e.createNotificationError({message:e.$tc("sw-flow.flowNotification.messageError")})})).finally((function(){e.isLoading=!1}))},createSequenceEntity:function(e){var t=this.flowSequenceRepository.create();return Object.keys(e).forEach((function(o){t[o]="trueCase"!==o?"config"!==o?e[o]:r({},e[o]):Boolean(e[o])})),t},buildSequencesFromConfig:function(e){var t=this,o={};e=e.map((function(e){return e=t.createSequenceEntity(e),o[e.id]=d.createId(),e.id=o[e.id],e}));for(var i=0;i<e.length;i+=1)null!==e[i].parentId&&(e[i].parentId=o[e[i].parentId]);return e=m("flowBuilderService").rearrangeArrayObjects(e),new g(this.flowSequenceRepository.source,this.flowSequenceRepository.entityName,w.api,null,e)},getRuleDataForFlowTemplate:function(){var e=this,t=this.sequences.filter((function(e){return null!==e.ruleId})).map((function(e){return e.ruleId}));if(t.length){var o=new h(1,25);o.addFilter(h.equalsAny("id",t)),this.ruleRepository.search(o).then((function(t){var o=e.sequences.map((function(e){return e.ruleId&&(e.rule=t.find((function(t){return t.id===e.ruleId}))),e}));f.commit("swFlowState/setSequences",o),f.commit("swFlowState/setOriginFlow",S(e.flow))}))}}}}},zEvv:function(e,t,o){}}]);