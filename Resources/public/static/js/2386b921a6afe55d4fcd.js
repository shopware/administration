(window.webpackJsonpAdministration=window.webpackJsonpAdministration||[]).push([[23313],{401049:function(){},323313:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return n}}),i(14670);let{Criteria:a}=Shopware.Data,{mapState:r}=Shopware.Component.getComponentHelper();var n={template:'\n{% block sw_category_tree %}\n<div class="sw-category-tree">\n    <sw-tree\n        v-if="!isLoadingInitialData"\n        ref="categoryTree"\n        class="sw-category-tree__inner"\n        after-id-property="afterCategoryId"\n        :items="categories"\n        :sortable="sortable"\n        :searchable="false"\n        :active-tree-item-id="categoryId"\n        :translation-context="translationContext"\n        :on-change-route="changeCategory"\n        :disable-context-menu="disableContextMenu"\n        :allow-delete-categories="allowDelete || undefined"\n        initially-expanded-root\n        @batch-delete="deleteCheckedItems"\n        @delete-element="onDeleteCategory"\n        @drag-end="onUpdatePositions"\n        @get-tree-items="onGetTreeItems"\n        @editing-end="syncSiblings"\n        @checked-elements-count="checkedElementsCount"\n    >\n\n        <template #headline>\n            <span></span>\n        </template>\n\n        \n        {% block sw_category_tree_items %}\n        <template\n            #items="{\n                treeItems,\n                sortable,\n                draggedItem,\n                newElementId,\n                checkItem,\n                translationContext,\n                onChangeRoute,\n                disableContextMenu,\n                selectedItemsPathIds,\n                checkedItemIds,\n            }"\n        >\n            <sw-tree-item\n                v-for="item in treeItems"\n                :key="item.id"\n                :item="item"\n                :should-show-active-state="true"\n                :allow-duplicate="false"\n                :allow-new-categories="allowCreate || undefined"\n                :allow-delete-categories="allowDelete || undefined"\n                :active="item.active"\n                :translation-context="translationContext"\n                :on-change-route="onChangeRoute"\n                :sortable="sortable"\n                :dragged-item="draggedItem"\n                :disable-context-menu="disableContextMenu"\n                :display-checkbox="allowEdit || undefined"\n                :context-menu-tooltip-text="contextMenuTooltipText"\n                :new-element-id="newElementId"\n                :get-item-url="getCategoryUrl"\n                :get-is-highlighted="isHighlighted"\n                :active-parent-ids="selectedItemsPathIds"\n                :active-item-ids="checkedItemIds"\n                @check-item="checkItem"\n            />\n        </template>\n        {% endblock %}\n    </sw-tree>\n\n    <div v-else>\n        <sw-skeleton variant="tree-item" />\n        <sw-skeleton variant="tree-item-nested" />\n        <sw-skeleton variant="tree-item-nested" />\n        <sw-skeleton variant="tree-item-nested" />\n        <sw-skeleton variant="tree-item" />\n        <sw-skeleton variant="tree-item-nested" />\n        <sw-skeleton variant="tree-item-nested" />\n    </div>\n</div>\n{% endblock %}\n',compatConfig:Shopware.compatConfig,inject:["repositoryFactory","syncService"],emits:["category-checked-elements-count","unsaved-changes"],mixins:["notification"],props:{categoryId:{type:String,required:!1,default:null},currentLanguageId:{type:String,required:!0},allowEdit:{type:Boolean,required:!1,default:!0},allowCreate:{type:Boolean,required:!1,default:!0},allowDelete:{type:Boolean,required:!1,default:!0}},data(){return{loadedCategories:{},translationContext:"sw-category",linkContext:"sw.category.detail",isLoadingInitialData:!0,loadedParentIds:[],sortable:this.allowEdit}},computed:{...r("swCategoryDetail",["categoriesToDelete"]),categoryRepository(){return this.repositoryFactory.create("category")},category(){return Shopware.State.get("swCategoryDetail").category},categories(){return Object.values(this.loadedCategories)},disableContextMenu(){return!this.allowEdit||this.currentLanguageId!==Shopware.Context.api.systemLanguageId},contextMenuTooltipText(){return this.allowEdit?null:this.$tc("sw-privileges.tooltip.warning")},criteria(){return new a(1,500).addAssociation("navigationSalesChannels").addAssociation("footerSalesChannels").addAssociation("serviceSalesChannels")},criteriaWithChildren(){let e=a.fromCriteria(this.criteria).setLimit(1);return e.associations.push({association:"children",criteria:a.fromCriteria(this.criteria)}),e},cmsPageRepository(){return this.repositoryFactory.create("cms_page")},productRepository(){return this.repositoryFactory.create("product")}},watch:{categoriesToDelete(e){void 0!==e&&(this.$refs.categoryTree.onDeleteElements(e),Shopware.State.commit("swCategoryDetail/setCategoriesToDelete",{categoriesToDelete:void 0}))},allowEdit(e){this.sortable=e},category(e,t){if(!t&&this.isLoadingInitialData){this.openInitialTree();return}if(null!==e&&t&&e.id===t.id){let i=[e.id,...t.navigationSalesChannels.map(e=>e.navigationCategoryId),...t.footerSalesChannels.map(e=>e.footerCategoryId),...t.serviceSalesChannels.map(e=>e.serviceCategoryId)],r=a.fromCriteria(this.criteria).setIds(i.filter((e,t,i)=>null!==e&&i.indexOf(e)===t));this.categoryRepository.search(r).then(e=>{this.addCategories(e)})}},currentLanguageId(){this.openInitialTree()}},created(){this.createdComponent()},methods:{createdComponent(){null!==this.category&&this.openInitialTree(),this.categoryId||this.loadRootCategories().finally(()=>{this.isLoadingInitialData=!1})},openInitialTree(){this.isLoadingInitialData=!0,this.loadedCategories={},this.loadedParentIds=[],this.loadRootCategories().then(()=>{if(!this.category||null===this.category.path)return this.isLoadingInitialData=!1,Promise.resolve();let e=this.category.path.split("|").filter(e=>!!e),t=[];return e.forEach(e=>{let i=this.categoryRepository.get(e,Shopware.Context.api,this.criteriaWithChildren).then(e=>{this.addCategories([e,...e.children])});t.push(i)}),Promise.all(t).then(()=>{this.isLoadingInitialData=!1})})},onUpdatePositions:Shopware.Utils.debounce(function({draggedItem:e,oldParentId:t,newParentId:i}){e.children.length>0&&(e.children.forEach(e=>{this.removeFromStore(e.id)}),this.loadedParentIds=this.loadedParentIds.filter(t=>t!==e.id)),this.syncSiblings({parentId:i}).then(()=>{t!==i&&this.syncSiblings({parentId:t}).then(()=>{this.syncProducts(e.id)}),this.sortable=this.allowEdit})},400),syncProducts(e){let t=new a(1,50);return t.addFilter(a.multi("or",[a.equals("categoriesRo.id",e),a.equals("categories.id",e)])),this.productRepository.iterateIds(t,this.indexProducts)},indexProducts(e){let t=this.productRepository.buildHeaders();return Shopware.Application.getContainer("init").httpClient.post("/_action/index-products",{ids:e},{headers:t})},checkedElementsCount(e){this.$emit("category-checked-elements-count",e)},async deleteCheckedItems(e){let t=Object.keys(e);if(t.some(e=>this.loadedCategories[e]?.navigationSalesChannels!==null&&this.loadedCategories[e]?.navigationSalesChannels.length>0)){this.createNotificationError({message:this.$tc("sw-category.general.errorNavigationEntryPointMultiple")});let e=t.map(e=>this.loadedCategories[e]);t.forEach(e=>{this.isCompatEnabled("INSTANCE_DELETE")?this.$delete(this.loadedCategories,e):delete this.loadedCategories[e]}),this.$nextTick(()=>{this.addCategories(e)});return}await this.categoryRepository.syncDeleted(t,Shopware.Context.api);let i=t.map(e=>this.loadedCategories[e]);await this.fixSortingForCategories(i),t.forEach(e=>{this.removeFromStore(e)})},onDeleteCategory({data:e,children:t,checked:i}){if(e.isNew())return this.isCompatEnabled("INSTANCE_DELETE")?this.$delete(this.loadedCategories,e.id):delete this.loadedCategories[e.id],Promise.resolve();if(this.isErrorNavigationEntryPoint(e)){e.isDeleted=!1,t.length>0&&t.forEach(e=>{e.data.isDeleted=!1});let i=this.getNextCategory(e);return i&&(i.afterCategoryId=e.id),this.loadedCategories={...this.loadedCategories},this.createNotificationError({message:this.entryPointWarningMessage(e)}),Promise.resolve()}return this.categoryRepository.delete(e.id).then(async()=>{if(this.removeFromStore(e.id),null!==e.parentId){let t=await this.categoryRepository.get(e.parentId,Shopware.Context.api,this.criteria);this.addCategory(t)}await this.fixSortingForCategories([e],!0),e.id===this.categoryId&&this.$router.push({name:"sw.category.index"}),!0===i&&(this.$refs.categoryTree.checkedElementsCount-=1,this.$emit("category-checked-elements-count",this.$refs.categoryTree.checkedElementsCount))})},fixSortingForCategories(e,t=!1){let i=[];return e.forEach(a=>{let r=this.getNextCategory(a,t?"afterCategoryId":"id");r&&(r.afterCategoryId=a.afterCategoryId,e.find(e=>e.id===r.id)||i.push(r))}),this.categoryRepository.saveAll(i)},getNextCategory(e,t="id"){return Object.values(this.loadedCategories).find(i=>i.parentId===e.parentId&&i.afterCategoryId===e[t])},changeCategory(e){let t={name:"sw.category.detail",params:{id:e.id}};this.category&&this.categoryRepository.hasChanges(this.category)?this.$emit("unsaved-changes",t):this.$router.push(t)},onGetTreeItems(e){if(this.loadedParentIds.includes(e))return Promise.resolve();let t=a.fromCriteria(this.criteria);return t.addFilter(a.equals("parentId",e)),t.setIds([]),this.categoryRepository.search(t).then(t=>{this.addCategories(t),this.loadedParentIds.push(e)})},getChildrenFromParent(e){return this.onGetTreeItems(e)},loadRootCategories(){let e=a.fromCriteria(this.criteria).addFilter(a.equals("parentId",null));return this.categoryRepository.search(e).then(e=>{this.addCategories(e)})},createNewElement(e,t,i=""){this.sortable=!1,!t&&e&&(t=e.parentId);let a=this.createNewCategory(i,t);return this.addCategory(a),a},createNewCategory(e,t){let i=this.categoryRepository.create();return i.name=e,i.parentId=t,i.childCount=0,i.active=!1,i.visible=!0,i.save=()=>this.categoryRepository.save(i).then(()=>{let e=a.fromCriteria(this.criteria).setIds([i.id,t].filter(e=>null!==e));this.categoryRepository.search(e).then(e=>{this.addCategories(e),this.sortable=this.allowEdit})}),i},syncSiblings({parentId:e}){let t=this.categories.filter(t=>t.parentId===e);return this.categoryRepository.sync(t).then(()=>(this.loadedParentIds=this.loadedParentIds.filter(t=>t!==e),this.getChildrenFromParent(e))).then(()=>{this.categoryRepository.get(e,Shopware.Context.api,this.criteria).then(e=>{this.addCategory(e)})})},addCategory(e){e&&(this.isCompatEnabled("INSTANCE_SET")?this.$set(this.loadedCategories,e.id,e):this.loadedCategories[e.id]=e)},addCategories(e){e.forEach(e=>{this.isCompatEnabled("INSTANCE_SET")?this.$set(this.loadedCategories,e.id,e):this.loadedCategories[e.id]=e})},removeFromStore(e){let t=this.getDeletedIds(e);this.loadedParentIds=this.loadedParentIds.filter(e=>!t.includes(e)),t.forEach(e=>{this.isCompatEnabled("INSTANCE_DELETE")?this.$delete(this.loadedCategories,e):delete this.loadedCategories[e]})},getDeletedIds(e){let t=[e];return Object.keys(this.loadedCategories).forEach(i=>{this.loadedCategories[i].parentId===e&&t.push(...this.getDeletedIds(i))}),t},getCategoryUrl(e){return this.$router.resolve({name:this.linkContext,params:{id:e.id}}).href},isHighlighted({data:e}){return null!==e.navigationSalesChannels&&e.navigationSalesChannels.length>0||null!==e.serviceSalesChannels&&e.serviceSalesChannels.length>0||null!==e.footerSalesChannels&&e.footerSalesChannels.length>0},isErrorNavigationEntryPoint(e){let{navigationSalesChannels:t,serviceSalesChannels:i,footerSalesChannels:a}=e;return[t,i,a].some(e=>null!==e&&e?.length>0)},entryPointWarningMessage(e){let{serviceSalesChannels:t,footerSalesChannels:i}=e;return null!==t&&t?.length>0?this.$tc("sw-category.general.errorNavigationEntryPoint",0,{entryPointLabel:this.$tc("sw-category.base.entry-point-card.types.labelServiceNavigation")}):null!==i&&i?.length>0?this.$tc("sw-category.general.errorNavigationEntryPoint",0,{entryPointLabel:this.$tc("sw-category.base.entry-point-card.types.labelFooterNavigation")}):this.$tc("sw-category.general.errorNavigationEntryPoint",0,{entryPointLabel:this.$tc("sw-category.base.entry-point-card.types.labelMainNavigation")})}}}},14670:function(e,t,i){var a=i(401049);a.__esModule&&(a=a.default),"string"==typeof a&&(a=[[e.id,a,""]]),a.locals&&(e.exports=a.locals),i(745346).Z("60c274ce",a,!0,{})}}]);