(window.webpackJsonpAdministration=window.webpackJsonpAdministration||[]).push([[23457],{670102:function(){},623457:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return p}}),i(938989);let{Component:o,Mixin:s,Context:a,State:r,Utils:n,Service:l}=Shopware,{Criteria:c,EntityCollection:w}=Shopware.Data,{cloneDeep:h}=Shopware.Utils.object,{mapState:d,mapGetters:m,mapPropertyErrors:u}=o.getComponentHelper();var p={template:'\n{% block sw_flow_detail %}\n<sw-page class="sw-flow-detail">\n    \n    {% block sw_flow_detail_header %}\n    <template #smart-bar-header>\n        <h2>{{ placeholder(flow, \'name\', $tc(\'sw-flow.detail.textHeadline\')) }}</h2>\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_flow_detail_smart_bar_actions %}\n    <template #smart-bar-actions>\n        \n        {% block sw_flow_detail_smart_bar_actions_save %}\n        <sw-button-process\n            v-tooltip="{\n                message: $tc(\'sw-privileges.tooltip.warning\'),\n                disabled: acl.can(\'flow.editor\'),\n                position: \'bottom\',\n                showOnDisabledElements: true\n            }"\n            class="sw-flow-detail__save"\n            variant="primary"\n            :is-loading="isLoading"\n            :process-success="isSaveSuccessful"\n            :disabled="!acl.can(\'flow.editor\')"\n            @update:process-success="saveFinish"\n            @click.prevent="onSave"\n        >\n            {{ $tc(\'global.default.save\') }}\n        </sw-button-process>\n        {% endblock %}\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_flow_content %}\n    <template #content>\n        \n        {% block sw_flow_leave_page_modal %}\n        <sw-flow-leave-page-modal\n            v-if="showLeavePageWarningModal"\n            @page-leave-cancel="onLeaveModalClose"\n            @page-leave-confirm="onLeaveModalConfirm"\n        />\n        {% endblock %}\n\n        <sw-card-view :class="{\'sw-flow-detail__template\': isTemplate }">\n            \n            {% block sw_flow_tabs_header %}\n            <sw-tabs position-identifier="sw-flow-detail">\n                \n                {% block sw_flow_tabs_header_general %}\n                <sw-tabs-item\n                    class="sw-flow-detail__tab-general"\n                    :route="routeDetailTab(\'general\')"\n                >\n                    {{ $tc(\'sw-flow.page.tabGeneral\') }}\n                </sw-tabs-item>\n                {% endblock %}\n\n                \n                {% block sw_flow_tabs_header_builder %}\n                <sw-tabs-item\n                    class="sw-flow-detail__tab-flow"\n                    :route="routeDetailTab(\'flow\')"\n                >\n                    {{ $tc(\'sw-flow.page.tabFlow\') }}\n                </sw-tabs-item>\n                {% endblock %}\n\n                \n                {% block sw_flow_tabs_header_extension %}{% endblock %}\n            </sw-tabs>\n            {% endblock %}\n            <sw-alert\n                v-if="isTemplate"\n                variant="warning"\n                class="sw-flow-detail__warning"\n            >\n                {{ $tc(\'sw-flow.flowNotification.messageWarningSave\') }}\n            </sw-alert>\n            \n            {% block sw_flow_tabs_content %}\n            <template v-if="isLoading">\n                <sw-skeleton />\n                <sw-skeleton />\n            </template>\n\n            <template v-else>\n                <router-view\n                    v-slot="{ Component }"\n                >\n                    <component\n                        :is="Component"\n                        :is-loading="isLoading"\n                        :is-new-flow="isNewFlow"\n                        :is-template="isTemplate"\n                        :is-unknown-trigger="isUnknownTrigger"\n                    />\n                </router-view>\n            </template>\n            {% endblock %}\n        </sw-card-view>\n\n        \n        {% block sw_flow_detail_modal_extension %}{% endblock %}\n    </template>\n    {% endblock %}\n</sw-page>\n{% endblock %}\n',compatConfig:Shopware.compatConfig,inject:["acl","repositoryFactory","feature","flowBuilderService"],mixins:[s.getByName("placeholder"),s.getByName("notification")],props:{flowId:{type:String,required:!1,default:null}},data(){return{isLoading:!1,isSaveSuccessful:!1,showLeavePageWarningModal:!1,nextRoute:null}},metaInfo(){return{title:this.$createTitle(this.identifier)}},computed:{identifier(){return this.flow?.name},flowRepository(){return this.repositoryFactory.create("flow")},flowTemplateRepository(){return this.repositoryFactory.create("flow_template")},flowSequenceRepository(){return this.repositoryFactory.create("flow_sequence")},appFlowActionRepository(){return this.repositoryFactory.create("app_flow_action")},isNewFlow(){return!this.flowId},flowCriteria(){let e=new c(1,25);return e.addAssociation("sequences.rule"),e.getAssociation("sequences").addSorting(c.sort("displayGroup","ASC")).addSorting(c.sort("parentId","ASC")).addSorting(c.sort("trueCase","ASC")).addSorting(c.sort("position","ASC")),e},flowTemplateCriteria(){return new c(1,25)},documentTypeRepository(){return this.repositoryFactory.create("document_type")},documentTypeCriteria(){let e=new c(1,100);return e.addSorting(c.sort("name","ASC")),e},mailTemplateRepository(){return this.repositoryFactory.create("mail_template")},customFieldSetRepository(){return this.repositoryFactory.create("custom_field_set")},customFieldRepository(){return this.repositoryFactory.create("custom_field")},mailTemplateIdsCriteria(){let e=new c(1,25);return e.addAssociation("mailTemplateType"),e.addFilter(c.equalsAny("id",this.mailTemplateIds)),e},customerGroupRepository(){return this.repositoryFactory.create("customer_group")},customerGroupCriteria(){let e=new c(1,100);return e.addSorting(c.sort("name","ASC")),e},appFlowActionCriteria(){let e=new c(1,25);return e.addAssociation("app"),e},stateMachineStateRepository(){return this.repositoryFactory.create("state_machine_state")},stateMachineStateCriteria(){let e=new c(1,null);return e.addSorting({field:"name",order:"ASC"}),e.addAssociation("stateMachine"),e.addFilter(c.equalsAny("state_machine_state.stateMachine.technicalName",["order.state","order_transaction.state","order_delivery.state"])),e},customFieldSetCriteria(){let e=new c(1,25);return e.addFilter(c.equalsAny("id",this.customFieldSetIds)),e},customFieldCriteria(){let e=new c(1,25);return e.addFilter(c.equalsAny("id",this.customFieldIds)),e},ruleRepository(){return this.repositoryFactory.create("rule")},isTemplate(){return this.$route.query?.type==="template"},isUnknownTrigger(){return!!this.flowId&&!this.isLoading&&!this.triggerEvents.some(e=>e.name===this.flow.eventName)},...d("swFlowState",["flow","triggerEvents"]),...m("swFlowState",["sequences","mailTemplateIds","customFieldSetIds","customFieldIds","hasFlowChanged"]),...u("flow",["name","eventName"])},watch:{flowId(){this.$route.params.flowTemplateId||this.getDetailFlow()}},created(){this.createdComponent()},beforeRouteLeave(e,t,i){if(this.flow._isNew){i();return}this.hasFlowChanged?(this.nextRoute=i,this.showLeavePageWarningModal=!0):i()},beforeUnmount(){this.beforeDestroyComponent()},methods:{createdComponent(){if(l("flowBuilderService").addLabels({entity:"sw-flow.labelDescription.labelEntity",tagIds:"sw-flow.labelDescription.labelTag"}),Shopware.ExtensionAPI.publishData({id:"sw-flow-detail__flow",path:"flow",scope:this}),this.getAppFlowAction(),this.isTemplate){this.getDetailFlowTemplate();return}if(this.flowId){this.getDetailFlow();return}this.createNewFlow()},beforeDestroyComponent(){r.dispatch("swFlowState/resetFlowState")},routeDetailTab(e){return e?this.isNewFlow?this.$route.params.flowTemplateId?{name:`sw.flow.create.${e}`,params:{flowTemplateId:this.$route.params.flowTemplateId}}:{name:`sw.flow.create.${e}`}:this.isTemplate?{name:`sw.flow.detail.${e}`,query:{type:"template"}}:{name:`sw.flow.detail.${e}`}:{}},createNewFlow(){if(this.$route.params.flowTemplateId)return this.createFromFlowTemplate();let e=this.flowRepository.create();return e.id=n.createId(),e.priority=0,e.eventName="",r.commit("swFlowState/setFlow",e)},getDetailFlow(){return this.isLoading=!0,Shopware.State.dispatch("swFlowState/fetchTriggerActions"),this.flowRepository.get(this.flowId,a.api,this.flowCriteria).then(e=>{r.commit("swFlowState/setFlow",e),r.commit("swFlowState/setOriginFlow",h(e)),this.getDataForActionDescription()}).catch(()=>{this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageError")})}).finally(()=>{this.isLoading=!1})},getAppFlowAction(){return this.appFlowActionRepository.search(this.appFlowActionCriteria,Shopware.Context.api).then(e=>{r.commit("swFlowState/setAppActions",e)})},getDetailFlowTemplate(){return this.isLoading=!0,this.flowTemplateRepository.get(this.flowId,a.api,this.flowTemplateCriteria).then(e=>{r.commit("swFlowState/setFlow",e),r.commit("swFlowState/setOriginFlow",h(e)),this.getDataForActionDescription(),this.getRuleDataForFlowTemplate()}).catch(()=>{this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageError")})}).finally(()=>{this.isLoading=!1})},async onSave(){if(this.removeAllSelectors(),this.validateEmptySequence().length){this.createNotificationWarning({message:this.$tc("sw-flow.flowNotification.messageRequiredEmptyFields")});return}if(this.isSaveSuccessful=!1,this.isLoading=!0,this.isTemplate){this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageWarningSave")}),this.isLoading=!1;return}"function"==typeof this.flow.isNew&&this.flow.isNew()||this.isTemplate||await this.updateSequences(),this.flowRepository.save(this.flow).then(()=>{"function"==typeof this.flow.isNew&&this.flow.isNew()||this.$route.params.flowTemplateId?(this.createNotificationSuccess({message:this.$tc("sw-flow.flowNotification.messageCreateSuccess")}),this.$router.push({name:"sw.flow.detail",params:{id:this.flow.id}})):this.getDetailFlow(),this.isSaveSuccessful=!0}).catch(()=>{this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageSaveError")}),this.handleFieldValiationError()}).finally(()=>{this.isLoading=!1})},async updateSequences(){let e=this.sequences.map(e=>(e.flowId=this.flow.id,e));await this.flowSequenceRepository.sync(e);let t=this.getDeletedSequenceIds();t.length>0&&await this.flowSequenceRepository.syncDeleted(t);let i=await this.flowRepository.get(this.flowId,a.api);Object.keys(i).forEach(e=>{"sequences"!==e&&(i[e]=this.flow[e])}),r.commit("swFlowState/setFlow",i)},getDeletedSequenceIds(){let e=this.sequences.map(e=>e.id);return this.flow.getOrigin().sequences.filter(t=>!e.includes(t.id)).map(e=>e.id)},handleFieldValiationError(){if(!this.flowNameError&&!this.flowEventNameError)return;let e=this.$router.history.current.name,t=("sw.flow.create.flow"===e||"sw.flow.detail.flow"===e)&&this.flowEventNameError,i=("sw.flow.create.general"===e||"sw.flow.detail.general"===e)&&this.flowNameError;if(!t&&!i){if(this.flowId){this.$router.push({name:this.flowNameError?"sw.flow.detail.general":"sw.flow.detail.flow",params:{flowId:this.flowId}});return}this.$router.push({name:this.flowNameError?"sw.flow.create.general":"sw.flow.create.flow"})}},saveFinish(){this.isLoading=!1,this.isSaveSuccessful=!1},onLeaveModalClose(){this.nextRoute(!1),this.nextRoute=null,this.showLeavePageWarningModal=!1},onLeaveModalConfirm(){this.showLeavePageWarningModal=!1,this.$nextTick(()=>{this.nextRoute()})},removeAllSelectors(){let e=this.sequences.filter(e=>null!==e.ruleId||null!==e.actionName);r.commit("swFlowState/setSequences",e)},validateEmptySequence(){let e=this.sequences.reduce((e,t)=>((""===t.ruleId||""===t.actionName)&&e.push(t.id),e),[]);return r.commit("swFlowState/setInvalidSequences",e),e},getDataForActionDescription(){if(!this.sequences)return null;let e=[];this.sequences.some(e=>e.actionName===this.flowBuilderService.getActionName("SET_ORDER_STATE"))&&e.push(this.stateMachineStateRepository.search(this.stateMachineStateCriteria).then(e=>{r.commit("swFlowState/setStateMachineState",e)})),this.sequences.some(e=>e.actionName===this.flowBuilderService.getActionName("GENERATE_DOCUMENT"))&&e.push(this.documentTypeRepository.search(this.documentTypeCriteria).then(e=>{Shopware.State.commit("swFlowState/setDocumentTypes",e)})),this.sequences.some(e=>e.actionName===this.flowBuilderService.getActionName("MAIL_SEND"))&&e.push(this.mailTemplateRepository.search(this.mailTemplateIdsCriteria).then(e=>{Shopware.State.commit("swFlowState/setMailTemplates",e)})),this.sequences.some(e=>e.actionName===this.flowBuilderService.getActionName("CHANGE_CUSTOMER_GROUP"))&&e.push(this.customerGroupRepository.search(this.customerGroupCriteria).then(e=>{Shopware.State.commit("swFlowState/setCustomerGroups",e)}));let t=[this.flowBuilderService.getActionName("SET_ORDER_CUSTOM_FIELD"),this.flowBuilderService.getActionName("SET_CUSTOMER_CUSTOM_FIELD"),this.flowBuilderService.getActionName("SET_CUSTOMER_GROUP_CUSTOM_FIELD")];return this.sequences.some(e=>t.includes(e.actionName))&&(e.push(this.customFieldSetRepository.search(this.customFieldSetCriteria).then(e=>{Shopware.State.commit("swFlowState/setCustomFieldSets",e)})),e.push(this.customFieldRepository.search(this.customFieldCriteria).then(e=>{Shopware.State.commit("swFlowState/setCustomFields",e)}))),Promise.all(e)},createFromFlowTemplate(){let e=this.flowRepository.create();return e.id=n.createId(),e.priority=0,this.flowTemplateRepository.get(this.$route.params.flowTemplateId,a.api,this.flowTemplateCriteria).then(t=>{e.name=t.name,e.eventName=t.config?.eventName,e.description=t.config?.description,e.sequences=this.buildSequencesFromConfig(t.config?.sequences??[]),r.commit("swFlowState/setFlow",e),r.commit("swFlowState/setOriginFlow",h(e)),this.getDataForActionDescription(),this.getRuleDataForFlowTemplate()}).catch(()=>{this.createNotificationError({message:this.$tc("sw-flow.flowNotification.messageError")})}).finally(()=>{this.isLoading=!1})},createSequenceEntity(e){let t=this.flowSequenceRepository.create();return Object.keys(e).forEach(i=>{if("trueCase"===i){t[i]=!!e[i];return}if("config"===i){t[i]={...e[i]};return}t[i]=e[i]}),t},buildSequencesFromConfig(e){let t={};e=e.map(e=>(t[(e=this.createSequenceEntity(e)).id]=n.createId(),e.id=t[e.id],e));for(let i=0;i<e.length;i+=1)null!==e[i].parentId&&(e[i].parentId=t[e[i].parentId]);return e=l("flowBuilderService").rearrangeArrayObjects(e),new w(this.flowSequenceRepository.source,this.flowSequenceRepository.entityName,a.api,null,e)},getRuleDataForFlowTemplate(){let e=this.sequences.filter(e=>null!==e.ruleId).map(e=>e.ruleId);if(!e.length)return;let t=new c(1,25);t.addFilter(c.equalsAny("id",e)),this.ruleRepository.search(t).then(e=>{let t=this.sequences.map(t=>(t.ruleId&&(t.rule=e.find(e=>e.id===t.ruleId)),t));r.commit("swFlowState/setSequences",t),r.commit("swFlowState/setOriginFlow",h(this.flow))})}}}},938989:function(e,t,i){var o=i(670102);o.__esModule&&(o=o.default),"string"==typeof o&&(o=[[e.id,o,""]]),o.locals&&(e.exports=o.locals),i(745346).Z("6061abea",o,!0,{})}}]);