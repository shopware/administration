(window.webpackJsonpAdministration=window.webpackJsonpAdministration||[]).push([[61799],{162:function(){},61799:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return c}}),s(19873);var i=s(93135);let{Mixin:a}=Shopware,{Criteria:n}=Shopware.Data,{types:r}=Shopware.Utils,{intersectionBy:o,chunk:d,uniqBy:l}=Shopware.Utils.array;var c={template:'\n{% block sw_bulk_edit_order %}\n<sw-page class="sw-bulk-edit-order">\n    \n    {% block sw_bulk_edit_order_search_bar %}\n    <template #search-bar>\n\n        <sw-search-bar />\n\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_bulk_edit_order_smart_bar_header %}\n    <template #smart-bar-header>\n\n        <h2>{{ $tc(\'sw-bulk-edit.order.textTitle\', selectedIds.length, { orderTotal: selectedIds.length }) }}</h2>\n\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_bulk_edit_order_content_smart_bar_actions %}\n    <template #smart-bar-actions>\n\n        \n        {% block sw_bulk_edit_order_actions_save %}\n        <sw-button-process\n            class="sw-bulk-edit-order__save-action"\n            variant="primary"\n            :is-loading="isLoading"\n            :process-success="false"\n            :disabled="isLoading || !hasChanges"\n            @click="openModal"\n        >\n            {{ $tc(\'sw-bulk-edit.applyChanges\') }}\n        </sw-button-process>\n        {% endblock %}\n\n    </template>\n    {% endblock %}\n\n    \n    {% block sw_bulk_edit_order_content %}\n    <template #content>\n\n        <sw-card-view\n            v-if="selectedIds.length > 0 && isLoadedData"\n        >\n            <sw-card\n                v-if="restrictedFields.length"\n                class="sw-bulk-edit-order__restricted-fields"\n                position-identifier="sw-bulk-edit-order-restricted-fields"\n            >\n                <sw-alert\n                    :title="$tc(\'sw-bulk-edit.order.alertRestrictedFields.title\')"\n                    variant="warning"\n                >\n                    <span v-html="$tc(\'sw-bulk-edit.order.alertRestrictedFields.message\')"></span>\n                    <ul>\n                        <li\n                            v-for="(restrictedField, index) in restrictedFields"\n                            :key="index"\n                        >\n                            {{ $tc(`sw-bulk-edit.order.alertRestrictedFields.${restrictedField}`) }}\n                        </li>\n                    </ul>\n                </sw-alert>\n            </sw-card>\n\n            \n            {% block sw_bulk_edit_order_content_order_status_card %}\n            <sw-card\n                class="sw-bulk-edit-order-base__status"\n                position-identifier="sw-bulk-edit-order-status"\n                :title="$tc(\'sw-bulk-edit.order.status.cardTitle\')"\n                :is-loading="isLoading"\n            >\n                \n                {% block sw_bulk_edit_order_content_order_status_section %}\n                <sw-bulk-edit-change-type-field-renderer\n                    :form-fields="statusFormFields"\n                    :bulk-edit-data="bulkEditData"\n                    :entity="order"\n                />\n                {% endblock %}\n            </sw-card>\n            {% endblock %}\n\n            \n            {% block sw_bulk_edit_order_content_documents %}\n            <sw-card\n                class="sw-bulk-edit-order-base__documents"\n                position-identifier="sw-bulk-edit-order-documents"\n                :title="$tc(\'sw-bulk-edit.order.documents.cardTitle\')"\n                :is-loading="isLoading"\n            >\n                \n                {% block sw_bulk_edit_order_content_documents_content %}\n                <sw-bulk-edit-change-type-field-renderer\n                    :form-fields="documentsFormFields"\n                    :bulk-edit-data="bulkEditData"\n                    :entity="order"\n                    @change-value="onChangeDocument"\n                />\n                {% endblock %}\n            </sw-card>\n            {% endblock %}\n\n            \n            {% block sw_bulk_edit_order_tags_card %}\n            <sw-card\n                class="sw-bulk-edit-order-base__tags"\n                position-identifier="sw-bulk-edit-order-tags"\n                :title="$tc(\'sw-bulk-edit.order.tags.cardTitle\')"\n                :is-loading="isLoading"\n            >\n                \n                {% block sw_bulk_edit_order_tags %}\n                <sw-bulk-edit-change-type-field-renderer\n                    :form-fields="tagsFormFields"\n                    :bulk-edit-data="bulkEditData"\n                    :entity="order"\n                />\n                {% endblock %}\n            </sw-card>\n            {% endblock %}\n\n            \n            {% block sw_bulk_edit_order_custom_field_card %}\n            <sw-card\n                class="sw-bulk-edit-order-base__custom_fields"\n                position-identifier="sw-bulk-edit-order-custom-fields"\n                :title="$tc(\'sw-bulk-edit.order.customFields.cardTitle\')"\n                :is-loading="isLoading"\n            >\n                <sw-bulk-edit-custom-fields\n                    class="sw-bulk-edit__custom-fields"\n                    :sets="customFieldSets"\n                    @change="onCustomFieldsChange"\n                />\n            </sw-card>\n            {% endblock %}\n        </sw-card-view>\n\n        \n        {% block sw_bulk_edit_order_empty_state %}\n        <sw-empty-state\n            v-if="selectedIds.length <= 0 && !isLoading"\n            :title="$tc(\'sw-bulk-edit.order.messageEmptyTitle\')"\n            :subline="$tc(\'sw-bulk-edit.order.messageEmptySubline\')"\n        />\n        {% endblock %}\n\n        \n        {% block sw_bulk_edit_order_save_modal %}\n        <router-view\n            v-slot="{ Component }"\n        >\n            <component\n                :is="Component"\n                :item-total="selectedIds.length"\n                :is-loading="isLoading"\n                :process-status="processStatus"\n                :bulk-edit-data="bulkEditData"\n                @modal-close="closeModal"\n                @bulk-save="onSave"\n            />\n        </router-view>\n        {% endblock %}\n    </template>\n    {% endblock %}\n</sw-page>\n{% endblock %}\n',inject:["bulkEditApiFactory","repositoryFactory","feature","orderDocumentApiService"],mixins:[a.getByName("notification")],data(){return{isLoading:!1,isLoadedData:!1,bulkEditData:{},isStatusSelected:!1,isStatusMailsSelected:!1,orderStatus:[],transactionStatus:[],deliveryStatus:[],customFieldSets:[],itemsPerRequest:100,processStatus:"",order:{}}},metaInfo(){return{title:this.$createTitle()}},computed:{selectedIds(){return Shopware.State.get("shopwareApps").selectedIds},stateMachineStateRepository(){return this.repositoryFactory.create("state_machine_state")},orderRepository(){return this.repositoryFactory.create("order")},customFieldSetRepository(){return this.repositoryFactory.create("custom_field_set")},customFieldSetCriteria(){let e=new n(1,null);return e.addFilter(n.equals("relations.entityName","order")),e},hasChanges(){let e=this.bulkEditData.customFields?.value,t=Object.values(this.bulkEditData).some(e=>e.isChanged),s=!r.isEmpty(e)&&Object.keys(e).length>0;return t||s},restrictedFields(){let e=[];return"1"===this.$route.params.excludeDelivery&&(e=e.concat(["orderDeliveries"])),e},statusFormFields(){return[{name:"orderTransactions",config:{componentName:"sw-single-select",changeLabel:this.$tc("sw-bulk-edit.order.status.payment.label"),entity:"state_machine_state",placeholder:this.$tc("sw-bulk-edit.order.status.payment.placeholder"),options:this.transactionStatus}},{name:"orderDeliveries",config:{componentName:"sw-single-select",changeLabel:this.$tc("sw-bulk-edit.order.status.shipping.label"),entity:"state_machine_state",placeholder:this.$tc("sw-bulk-edit.order.status.shipping.placeholder"),options:this.deliveryStatus}},{name:"orders",config:{componentName:"sw-single-select",changeLabel:this.$tc("sw-bulk-edit.order.status.order.label"),entity:"state_machine_state",placeholder:this.$tc("sw-bulk-edit.order.status.order.placeholder"),options:this.orderStatus}},{name:"statusMails",labelHelpText:this.$tc("sw-bulk-edit.order.status.statusMails.helpText"),config:{hidden:!0,changeLabel:this.$tc("sw-bulk-edit.order.status.statusMails.label")}},{name:"documents",labelHelpText:this.$tc("sw-bulk-edit.order.status.documents.helpText"),config:{componentName:"sw-bulk-edit-order-documents",changeLabel:this.$tc("sw-bulk-edit.order.status.documents.label"),documents:this.bulkEditData?.documents}}].filter(e=>!this.restrictedFields.includes(e.name))},documentsFormFields(){return[{name:"invoice",labelHelpText:this.$tc("sw-bulk-edit.order.documents.generateInvoice.helpText"),config:{componentName:"sw-bulk-edit-order-documents-generate-invoice",changeLabel:this.$tc("sw-bulk-edit.order.documents.generateInvoice.label")}},{name:"storno",labelHelpText:this.$tc("sw-bulk-edit.order.documents.generateCancellationInvoice.helpText"),config:{componentName:"sw-bulk-edit-order-documents-generate-cancellation-invoice",changeLabel:this.$tc("sw-bulk-edit.order.documents.generateCancellationInvoice.label"),changeSubLabel:this.$tc("sw-bulk-edit.order.documents.generateCancellationInvoice.changeSubLabel")}},{name:"delivery_note",labelHelpText:this.$tc("sw-bulk-edit.order.documents.generateDeliveryNote.helpText"),config:{componentName:"sw-bulk-edit-order-documents-generate-delivery-note",changeLabel:this.$tc("sw-bulk-edit.order.documents.generateDeliveryNote.label")}},{name:"credit_note",labelHelpText:this.$tc("sw-bulk-edit.order.documents.generateCreditNote.helpText"),config:{componentName:"sw-bulk-edit-order-documents-generate-credit-note",changeLabel:this.$tc("sw-bulk-edit.order.documents.generateCreditNote.label"),changeSubLabel:this.$tc("sw-bulk-edit.order.documents.generateCreditNote.changeSubLabel")}},{name:"download",labelHelpText:this.$tc("sw-bulk-edit.order.documents.downloadDocuments.helpText"),config:{componentName:"sw-bulk-edit-order-documents-download-documents",changeLabel:this.$tc("sw-bulk-edit.order.documents.downloadDocuments.label")}}]},tagsFormFields(){return[{name:"tags",config:{componentName:"sw-entity-tag-select",entityCollection:this.order.tags,allowOverwrite:!0,allowClear:!0,allowAdd:!0,allowRemove:!0,changeLabel:this.$tc("sw-bulk-edit.order.tags.changeLabel"),placeholder:this.$tc("sw-bulk-edit.order.tags.placeholder")}}]}},watch:{bulkEditData:{handler(e){let{orders:t,orderTransactions:s,orderDeliveries:i,statusMails:a}=e;this.isStatusSelected=t.isChanged&&t.value||s.isChanged&&s.value||i?.isChanged&&i.value,this.isStatusMailsSelected=a.isChanged},deep:!0},isStatusSelected(){this.isStatusSelected||(this.bulkEditData.statusMails.isChanged=!1),this.bulkEditData.statusMails.disabled=!this.isStatusSelected},isStatusMailsSelected(){this.isStatusMailsSelected||(this.bulkEditData.documents.isChanged=!1),this.bulkEditData.documents.disabled=!this.isStatusMailsSelected}},beforeCreate(){Shopware.State.registerModule("swBulkEdit",i.Z)},created(){this.createdComponent()},beforeDestroy(){Shopware.State.unregisterModule("swBulkEdit")},methods:{async createdComponent(){this.setRouteMetaModule(),this.isLoading=!0,this.order=this.orderRepository.create(Shopware.Context.api),await Promise.all([this.fetchStatusOptions("orders.id"),this.fetchStatusOptions("orderTransactions.orderId"),this.fetchStatusOptions("orderDeliveries.orderId"),this.loadCustomFieldSets()]),this.isLoading=!1,this.isLoadedData=!0,this.loadBulkEditData()},setRouteMetaModule(){this.$set(this.$route.meta.$module,"color","#A092F0"),this.$set(this.$route.meta.$module,"icon","regular-shopping-bag")},loadBulkEditData(){[this.statusFormFields,this.documentsFormFields,this.tagsFormFields].forEach(e=>{e.forEach(e=>{this.$set(this.bulkEditData,e.name,{isChanged:!1,type:"overwrite",value:null})})}),this.$set(this.bulkEditData,"customFields",{type:"overwrite",value:null}),this.$set(this.bulkEditData,"statusMails",{...this.bulkEditData.statusMails,disabled:!0}),this.$set(this.bulkEditData,"documents",{...this.bulkEditData.documents,disabled:!0}),this.order.documents={documentType:{},skipSentDocuments:!0}},fetchStatusOptions(e){return this.fetchStateMachineStates(e).then(e=>this.fetchToStateMachineTransitions(e)).then(t=>{switch(e){case"orderTransactions.orderId":this.transactionStatus=t;break;case"orderDeliveries.orderId":this.deliveryStatus=t;break;default:this.orderStatus=t}}).catch(e=>this.createNotificationError({message:e}))},fetchStateMachineStates(e){let t=d(this.selectedIds,this.itemsPerRequest),s=null;switch(e){case"orderTransactions.orderId":s="orderTransactions.orderVersionId";break;case"orderDeliveries.orderId":s="orderDeliveries.orderVersionId";break;default:s="orders.versionId"}return Promise.all(t.map(t=>{let i=new n(1,null);return i.addFilter(n.multi("AND",[n.equalsAny(e,t),n.equals(s,Shopware.Context.api.liveVersionId)])),this.stateMachineStateRepository.searchIds(i)})).then(e=>{let t=[];return e.forEach(e=>{e?.data&&(t=[...e.data])}),t}).catch(e=>this.createNotificationError({message:e}))},fetchToStateMachineTransitions(e){return e.length?this.stateMachineStateRepository.search(this.toStateMachineStatesCriteria(e),Shopware.Context.api).then(e=>{if(!e.length)return[];let t=o(...e.map(e=>e?.fromStateMachineTransitions?e.fromStateMachineTransitions:null).filter(e=>null!==e),"actionName").filter(e=>e?.toStateMachineState);return(t=l(t,e=>e.toStateMachineState.technicalName)).map(e=>({label:e.toStateMachineState.translated.name,value:e.actionName}))}).catch(e=>this.createNotificationError({message:e})):Promise.resolve([])},toStateMachineStatesCriteria(e){let t=new n(1,25);return t.addFilter(n.equalsAny("id",e)),t.addAssociation("fromStateMachineTransitions.toStateMachineState"),t},onProcessData(){let e={statusData:[],syncData:[]},t=["orderTransactions","orderDeliveries","orders"];return Object.entries(this.bulkEditData).forEach(([s,i])=>{if(i.isChanged||"customFields"===s&&i.value){let a={field:s,type:i.type,value:i.value};if(t.includes(s)){let t=this.order?.documents?.documentType;if(this.bulkEditData?.documents?.isChanged){let e=Object.keys(t).filter(e=>!0===t[e]);e.length>0&&(a.documentTypes=e,a.skipSentDocuments=this.order.documents.skipSentDocuments)}a.sendMail=this.bulkEditData?.statusMails?.isChanged,a.value=this.order?.[s],e.statusData.push(a)}else"documents"!==s&&"statusMails"!==s&&e.syncData.push(a)}}),e},openModal(){this.$router.push({name:"sw.bulk.edit.order.save"})},closeModal(){this.$router.push({name:"sw.bulk.edit.order"})},onSave(){this.isLoading=!0;let{statusData:e,syncData:t}=this.onProcessData(),s=this.bulkEditApiFactory.getHandler("order"),i=d(this.selectedIds,this.itemsPerRequest),a=[];return i.forEach(i=>{e.length&&a.push(s.bulkEditStatus(i,e)),t.length&&a.push(s.bulkEdit(i,t))}),Promise.all(a).then(()=>{this.processStatus="success"}).catch(()=>{this.processStatus="fail"}).finally(()=>{this.isLoading=!1,this.getLatestOrderStatus().finally(()=>{this.isLoading=!1})})},getLatestOrderStatus(){let e=[];return(this.bulkEditData.orderTransactions.isChanged&&e.push(this.fetchStatusOptions("orderTransactions.order.id")),this.bulkEditData.orderDeliveries?.isChanged&&e.push(this.fetchStatusOptions("orderDeliveries.order.id")),this.bulkEditData.orders.isChanged&&e.push(this.fetchStatusOptions("orders.id")),0===e.length)?Promise.resolve():(this.isLoading=!0,Promise.all(e))},loadCustomFieldSets(){return this.customFieldSetRepository.search(this.customFieldSetCriteria).then(e=>{this.customFieldSets=e})},onCustomFieldsChange(e){this.bulkEditData.customFields.value=e},onChangeDocument(e,t){Shopware.State.commit("swBulkEdit/setOrderDocumentsIsChanged",{type:e,isChanged:t})}}}},93135:function(e,t){"use strict";t.Z={namespaced:!0,state(){let e=new Date().toISOString();return{isFlowTriggered:!0,orderDocuments:{invoice:{isChanged:!1,value:{documentDate:e,documentComment:null}},storno:{isChanged:!1,value:{documentDate:e,documentComment:null}},delivery_note:{isChanged:!1,value:{custom:{deliveryDate:e,deliveryNoteDate:e},documentDate:e,documentComment:null}},credit_note:{isChanged:!1,value:{documentDate:e,documentComment:null}},download:{isChanged:!1,value:[]}}}},mutations:{setIsFlowTriggered(e,t){e.isFlowTriggered=t},setOrderDocumentsIsChanged(e,{type:t,isChanged:s}){e.orderDocuments[t].isChanged=s},setOrderDocumentsValue(e,{type:t,value:s}){e.orderDocuments[t].value=s}},getters:{documentTypeConfigs(e){let t=[];return Object.entries(e.orderDocuments).forEach(([e,s])=>{"download"!==e&&!0===s.isChanged&&t.push({fileType:"pdf",type:e,config:s.value})}),t}}}},19873:function(e,t,s){var i=s(162);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[e.id,i,""]]),i.locals&&(e.exports=i.locals),s(45346).Z("58399cd3",i,!0,{})}}]);